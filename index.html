<!DOCTYPE html>
<html>

<head>
    <base href="https://2d-top-down-multiplayer-game.com/" />
    <title>тест шкибиди</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <canvas id="gameCanvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.2/browser/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        const app = new PIXI.Application({
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: 0x87CEEB, // Sky blue background
            view: document.getElementById('gameCanvas')
        });

        const gameWorld = new PIXI.Container();
        app.stage.addChild(gameWorld);

        const platformWidth = 1000;
        const platformHeight = 1000;

        class Character extends PIXI.Container {
            constructor(x, y, name) {
                super();
                this.x = x;
                this.y = y;

                this.sprite = new PIXI.Graphics();
                this.sprite.beginFill(0xFF0000);
                this.sprite.drawRect(-15, -15, 30, 30);
                this.sprite.endFill();
                this.addChild(this.sprite);

                const direction = new PIXI.Graphics();
                direction.beginFill(0xFFFF00);
                direction.moveTo(0, -20);
                direction.lineTo(10, -5);
                direction.lineTo(-10, -5);
                direction.closePath();
                direction.endFill();
                this.addChild(direction);

                this.nameText = new PIXI.Text(name, {
                    fontFamily: 'Arial',
                    fontSize: 14,
                    fill: 0x000000,
                    align: 'center'
                });
                this.nameText.anchor.set(0.5, 1);
                this.nameText.position.set(0, -25);
                this.addChild(this.nameText);
            }

            move(dx, dy) {
                let newX = this.x + dx;
                let newY = this.y + dy;

                newX = Math.max(-platformWidth / 2 + 15, Math.min(platformWidth / 2 - 15, newX));
                newY = Math.max(-platformHeight / 2 + 15, Math.min(platformHeight / 2 - 15, newY));

                this.x = newX;
                this.y = newY;
            }
        }

        const platform = new PIXI.Graphics();
        platform.beginFill(0x00FF00);
        platform.drawRect(-platformWidth / 2, -platformHeight / 2, platformWidth, platformHeight);
        platform.endFill();
        gameWorld.addChild(platform);

        const localPlayer = new Character(0, 0, "Player1");
        gameWorld.addChild(localPlayer);

        const otherPlayers = {};

        const obstacles = new PIXI.Graphics();
        obstacles.beginFill(0x8B4513);
        obstacles.drawRect(-200, -200, 100, 100);
        obstacles.drawRect(200, 200, 150, 150);
        obstacles.drawRect(-300, 300, 120, 120);
        obstacles.endFill();
        gameWorld.addChild(obstacles);

        const keys = {};

        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        const socket = io('http://localhost:3000');

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('updatePlayers', (players) => {
            Object.keys(players).forEach(id => {
                if (id !== socket.id) {
                    if (!otherPlayers[id]) {
                        otherPlayers[id] = new Character(players[id].x, players[id].y, `Player${id.substr(0, 4)}`);
                        gameWorld.addChild(otherPlayers[id]);
                    } else {
                        otherPlayers[id].x = players[id].x;
                        otherPlayers[id].y = players[id].y;
                    }
                }
            });

            Object.keys(otherPlayers).forEach(id => {
                if (!players[id]) {
                    gameWorld.removeChild(otherPlayers[id]);
                    delete otherPlayers[id];
                }
            });
        });

        app.ticker.add((delta) => {
            const speed = 3 * delta;

            if (keys['w'] || keys['arrowup']) localPlayer.move(0, -speed);
            if (keys['s'] || keys['arrowdown']) localPlayer.move(0, speed);
            if (keys['a'] || keys['arrowleft']) localPlayer.move(-speed, 0);
            if (keys['d'] || keys['arrowright']) localPlayer.move(speed, 0);

            gameWorld.pivot.x = localPlayer.x;
            gameWorld.pivot.y = localPlayer.y;
            gameWorld.position.x = app.screen.width / 2;
            gameWorld.position.y = app.screen.height / 2;

            socket.emit('updatePosition', { x: localPlayer.x, y: localPlayer.y });
        });

        window.addEventListener('resize', () => {
            app.renderer.resize(window.innerWidth, window.innerHeight);
            gameWorld.position.x = app.screen.width / 2;
            gameWorld.position.y = app.screen.height / 2;
        });

        const instructions = new PIXI.Text('тест', {
            fontFamily: 'Arial',
            fontSize: 16,
            fill: 0x000000,
            align: 'center'
        });
        instructions.x = 10;
        instructions.y = 10;
        app.stage.addChild(instructions);
    </script>
</body>

</html>
